# Story 2.1: Coin Detail Page

## Status

Draft

## Story

**As a** user,  
**I want** to view detailed information about a specific coin,  
**so that** I can make informed decisions about cryptocurrencies.

## Acceptance Criteria

1. The Coin Detail Page loads when clicking on a coin from the list or selecting from search
2. Page displays comprehensive coin information including price, market data, and statistics
3. Page is responsive and works on mobile and desktop devices
4. Loading and error states are properly handled
5. Navigation back to the main list is intuitive
6. Feature passes all related unit tests

## Tasks / Subtasks

**ðŸš¨ CRITICAL: Commit frequently! Each checkbox completion should be a separate commit. See git workflow section at the end for the recommended commit sequence.**

- [ ] Create `useCoinDetail.ts` hook for fetching coin data (AC: 2)
  - [ ] Implement SWR hook to fetch from `/coins/{id}` endpoint
  - [ ] Include market data, price changes, and description
  - [ ] Handle loading and error states
  - [ ] Add proper TypeScript types for coin detail data
  - [ ] Implement data caching strategy

- [ ] Update Coin Detail Page layout and structure (AC: 1, 2, 3)
  - [ ] Replace placeholder content with real coin data
  - [ ] Create header section with coin logo, name, symbol, and rank
  - [ ] Add current price display with 24h change indicator
  - [ ] Implement responsive grid layout for statistics
  - [ ] Add back navigation button/breadcrumb

- [ ] Create `CoinStats.tsx` component for market statistics (AC: 2, 3)
  - [ ] Display market cap with formatted numbers
  - [ ] Show 24h trading volume
  - [ ] Include circulating and total supply
  - [ ] Add all-time high/low prices with dates
  - [ ] Implement responsive card layout
  - [ ] Use consistent number formatting utilities

- [ ] Create `PriceChanges.tsx` component for price movements (AC: 2, 3)
  - [ ] Show price changes for multiple timeframes (24h, 7d, 30d, 1y)
  - [ ] Use color coding (green/red) for positive/negative changes
  - [ ] Display percentage and absolute value changes
  - [ ] Add visual indicators (arrows/icons)
  - [ ] Ensure accessibility with proper ARIA labels

- [ ] Implement loading and error states (AC: 4)
  - [ ] Create skeleton loader matching page layout
  - [ ] Design error component with retry functionality
  - [ ] Handle 404 errors for invalid coin IDs
  - [ ] Add loading shimmer effects for better UX
  - [ ] Implement graceful degradation for missing data

- [ ] Add coin description section (AC: 2)
  - [ ] Display coin description from API (with HTML parsing)
  - [ ] Implement "Read more/less" functionality for long descriptions
  - [ ] Add official website and social media links
  - [ ] Include category tags and platform information
  - [ ] Sanitize HTML content for security

- [ ] Create comprehensive unit tests (AC: 6)
  - [ ] Test coin detail page with various coin IDs
  - [ ] Test useCoinDetail hook with mock data
  - [ ] Test loading and error state rendering
  - [ ] Test navigation from list and search
  - [ ] Test responsive behavior
  - [ ] Test number formatting edge cases
  - [ ] Test HTML sanitization in descriptions
  - [ ] Ensure all tests pass with `npm run test`

- [ ] Code quality verification
  - [ ] Run `npm run lint` - all linting rules must pass
  - [ ] Run `npm run format:check` - all code must be properly formatted
  - [ ] Run `npm run type-check` - TypeScript compilation must succeed
  - [ ] Pre-commit hooks must be working and passing

- [ ] Follow git workflow standards - COMMIT FREQUENTLY!
  - [ ] **IMPORTANT**: Commit after EACH subtask completion (see `docs/git-workflow.md`)
  - [ ] Use conventional commit format: `(type)[coin-detail] summary`
  - [ ] Recommended commit sequence:
    - [ ] `(feat)[coin-detail] Create useCoinDetail hook with SWR integration`
    - [ ] `(feat)[coin-detail] Update coin detail page layout with header section`
    - [ ] `(feat)[coin-detail] Create CoinStats component for market statistics`
    - [ ] `(feat)[coin-detail] Create PriceChanges component with timeframe data`
    - [ ] `(feat)[coin-detail] Add loading skeleton and error states`
    - [ ] `(feat)[coin-detail] Implement coin description with read more functionality`
    - [ ] `(feat)[coin-detail] Add navigation and breadcrumb components`
    - [ ] `(test)[coin-detail] Add unit tests for coin detail page`
    - [ ] `(test)[coin-detail] Add unit tests for useCoinDetail hook`
    - [ ] `(fix)[coin-detail] Handle edge cases and missing data gracefully`
  - [ ] Each commit must leave code in working state
  - [ ] Run quality checks before EACH commit

## Dev Notes

### Required shadcn/ui Components

**Components to Install:**

```bash
npx shadcn@latest add card       # For CoinStats and layout sections
npx shadcn@latest add skeleton   # For loading states
npx shadcn@latest add badge      # For rank display and tags
npx shadcn@latest add separator  # For visual separations
npx shadcn@latest add button     # For back navigation and retry
npx shadcn@latest add breadcrumb # For navigation context
npx shadcn@latest add alert      # For error states
npx shadcn@latest add collapsible # For read more/less functionality
npx shadcn@latest add tooltip    # For additional info on hover
```

**Already Installed Components to Use:**

- `command` - Already used in SearchCommand
- `dialog` - Can be reused if needed
- `input` - Already available
- `select` - Already available
- `toggle` - For theme switching

### API Endpoints

**Primary Endpoint**: `GET /coins/{id}`

- **Base URL**: `https://api.coingecko.com/api/v3`
- **Full URL**: `https://api.coingecko.com/api/v3/coins/{id}`
- **Method**: GET
- **Authentication**: None required for public tier

**Query Parameters:**

```typescript
interface CoinDetailParams {
  localization: false; // Reduce payload size
  tickers: false; // Not needed for basic view
  market_data: true; // Required for prices
  community_data: false; // Not needed
  developer_data: false; // Not needed
  sparkline: false; // Not needed for basic view
}
```

**Example Request:**

```
GET https://api.coingecko.com/api/v3/coins/bitcoin?localization=false&tickers=false&market_data=true&community_data=false&developer_data=false&sparkline=false
```

Example response structure:

```typescript
interface CoinDetailData {
  id: string;
  symbol: string;
  name: string;
  asset_platform_id: string | null;
  description: {
    en: string;
  };
  links: {
    homepage: string[];
    blockchain_site: string[];
    official_forum_url: string[];
    // ... more links
  };
  image: {
    thumb: string;
    small: string;
    large: string;
  };
  market_cap_rank: number;
  market_data: {
    current_price: { [key: string]: number };
    market_cap: { [key: string]: number };
    total_volume: { [key: string]: number };
    price_change_percentage_24h: number;
    price_change_percentage_7d: number;
    price_change_percentage_30d: number;
    price_change_percentage_1y: number;
    ath: { [key: string]: number };
    ath_date: { [key: string]: string };
    atl: { [key: string]: number };
    atl_date: { [key: string]: string };
    circulating_supply: number;
    total_supply: number;
    max_supply: number | null;
  };
  categories: string[];
  // ... more fields
}
```

### Component Architecture

**Page Component**: `/src/app/[coinId]/page.tsx` (already exists, needs implementation)

**Data Hook**: `/src/hooks/useCoinDetail.ts`

```typescript
// Hook implementation strategy
const useCoinDetail = (coinId: string) => {
  const { data, error, isLoading } = useSWR(
    coinId ? `/coins/${coinId}` : null,
    fetcher,
    {
      revalidateOnFocus: false,
      revalidateOnReconnect: true,
      dedupingInterval: 60000, // 1 minute cache
    }
  );
  return { coin: data, error, isLoading };
};
```

**Component Structure:**

```
src/
â”œâ”€â”€ app/
â”‚   â””â”€â”€ [coinId]/
â”‚       â””â”€â”€ page.tsx              # Main page component
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ CoinDetailHeader.tsx      # Logo, name, price, rank badge
â”‚   â”œâ”€â”€ CoinStats.tsx            # Market statistics grid (Card-based)
â”‚   â”œâ”€â”€ PriceChanges.tsx         # Price change indicators
â”‚   â”œâ”€â”€ CoinDescription.tsx      # About section with collapsible
â”‚   â”œâ”€â”€ CoinDetailSkeleton.tsx   # Loading skeleton
â”‚   â””â”€â”€ CoinDetailError.tsx      # Error state with retry
â””â”€â”€ hooks/
    â””â”€â”€ useCoinDetail.ts         # SWR data fetching hook
```

**Component Props Interfaces:**

```typescript
interface CoinDetailHeaderProps {
  coin: CoinDetailData;
}

interface CoinStatsProps {
  marketData: CoinDetailData['market_data'];
  rank: number;
}

interface PriceChangesProps {
  priceChanges: {
    '24h': number;
    '7d': number;
    '30d': number;
    '1y': number;
  };
}

interface CoinDescriptionProps {
  description: string;
  links: CoinDetailData['links'];
  categories: string[];
}
```

### Design Considerations

1. **Mobile First**: Stack elements vertically on mobile, use grid on desktop
2. **Loading States**: Use skeleton screens that match final layout
3. **Error Handling**: Show specific messages for 404 vs network errors
4. **Performance**: Cache coin detail data with SWR for quick navigation
5. **Accessibility**: Proper heading hierarchy and ARIA labels

### shadcn/ui Component Usage Guide

**Card Component** (for CoinStats):

```tsx
import {
  Card,
  CardContent,
  CardDescription,
  CardHeader,
  CardTitle,
} from '@/components/ui/card';

<Card>
  <CardHeader>
    <CardTitle>Market Statistics</CardTitle>
  </CardHeader>
  <CardContent className="grid gap-4">{/* Statistics grid */}</CardContent>
</Card>;
```

**Skeleton Component** (for loading states):

```tsx
import { Skeleton } from "@/components/ui/skeleton"

<Skeleton className="h-12 w-[250px]" />  // For title
<Skeleton className="h-4 w-[200px]" />   // For text
<Skeleton className="h-[125px] w-full rounded-xl" /> // For cards
```

**Badge Component** (for rank display):

```tsx
import { Badge } from "@/components/ui/badge"

<Badge variant="secondary">Rank #{rank}</Badge>
<Badge variant="outline">{category}</Badge>
```

**Breadcrumb Component** (for navigation):

```tsx
import {
  Breadcrumb,
  BreadcrumbItem,
  BreadcrumbLink,
  BreadcrumbList,
  BreadcrumbSeparator,
} from '@/components/ui/breadcrumb';

<Breadcrumb>
  <BreadcrumbList>
    <BreadcrumbItem>
      <BreadcrumbLink href="/">Home</BreadcrumbLink>
    </BreadcrumbItem>
    <BreadcrumbSeparator />
    <BreadcrumbItem>
      <BreadcrumbLink>{coin.name}</BreadcrumbLink>
    </BreadcrumbItem>
  </BreadcrumbList>
</Breadcrumb>;
```

**Alert Component** (for error states):

```tsx
import { Alert, AlertDescription, AlertTitle } from '@/components/ui/alert';
import { AlertCircle } from 'lucide-react';

<Alert variant="destructive">
  <AlertCircle className="h-4 w-4" />
  <AlertTitle>Error</AlertTitle>
  <AlertDescription>
    Failed to load coin data. Please try again.
  </AlertDescription>
</Alert>;
```

**Collapsible Component** (for description):

```tsx
import {
  Collapsible,
  CollapsibleContent,
  CollapsibleTrigger,
} from '@/components/ui/collapsible';

<Collapsible>
  <CollapsibleContent className="space-y-2">
    {/* Full description */}
  </CollapsibleContent>
  <CollapsibleTrigger asChild>
    <Button variant="ghost" size="sm">
      Read more
    </Button>
  </CollapsibleTrigger>
</Collapsible>;
```

### Utility Functions Needed

```typescript
// src/lib/utils.ts additions

export function formatCurrency(value: number, currency = 'usd'): string {
  return new Intl.NumberFormat('en-US', {
    style: 'currency',
    currency: currency.toUpperCase(),
    minimumFractionDigits: value < 1 ? 6 : 2,
    maximumFractionDigits: value < 1 ? 8 : 2,
  }).format(value);
}

export function formatMarketCap(value: number): string {
  const units = ['', 'K', 'M', 'B', 'T'];
  let unitIndex = 0;
  let scaledValue = value;

  while (scaledValue >= 1000 && unitIndex < units.length - 1) {
    unitIndex++;
    scaledValue /= 1000;
  }

  return `$${scaledValue.toFixed(2)}${units[unitIndex]}`;
}

export function formatPercentage(value: number): string {
  const formatted = value.toFixed(2);
  return value >= 0 ? `+${formatted}%` : `${formatted}%`;
}

export function sanitizeHTML(html: string): string {
  // Use DOMPurify or similar library
  // For now, basic implementation
  const div = document.createElement('div');
  div.textContent = html;
  return div.innerHTML;
}
```

### Integration Points

- Navigation from `CoinCard` component (already implemented)
- Navigation from `SearchCommand` component (already implemented)
- Back navigation to home page with preserved filters/search

## Testing

### Test Scenarios

1. **Page Load**: Verify page loads with valid coin ID
2. **Invalid ID**: Test 404 handling for non-existent coins
3. **Data Display**: Verify all market data renders correctly
4. **Responsive**: Test layout on mobile/tablet/desktop
5. **Navigation**: Test navigation to/from detail page
6. **Loading**: Verify skeleton screens appear during load
7. **Error States**: Test network error handling and retry

### Mock Data

Use realistic mock data for tests including edge cases:

- Coins with no max supply (Bitcoin)
- Coins with very small prices (SHIB)
- Coins with missing description
- Coins with extreme price changes

### Error Handling Strategy

```typescript
// src/hooks/useCoinDetail.ts
export function useCoinDetail(coinId: string) {
  const { data, error, isLoading, mutate } = useSWR(
    coinId ? `/coins/${coinId}` : null,
    fetcher,
    {
      onError: err => {
        if (err.status === 404) {
          // Coin not found
          throw new CoinNotFoundError(coinId);
        }
        // Network or other errors
        throw new NetworkError(err.message);
      },
    }
  );

  return {
    coin: data,
    error,
    isLoading,
    retry: () => mutate(),
  };
}
```

### Rate Limiting Considerations

- CoinGecko API has rate limits (10-50 calls/minute for free tier)
- Implement proper caching with SWR
- Consider adding request throttling if needed
- Display user-friendly messages when rate limited

### SEO Optimization

```tsx
// src/app/[coinId]/page.tsx
export async function generateMetadata({ params }: Props): Promise<Metadata> {
  const coin = await getCoinData(params.coinId);

  return {
    title: `${coin.name} (${coin.symbol.toUpperCase()}) Price & Market Data`,
    description: `View real-time ${coin.name} price, market cap, volume, and more. Current price: ${formatCurrency(coin.market_data.current_price.usd)}`,
    openGraph: {
      images: [coin.image.large],
    },
  };
}
```

## Change Log

| Date       | Version | Description                                             | Author              |
| ---------- | ------- | ------------------------------------------------------- | ------------------- |
| 2025-08-05 | 1.0     | Initial story creation                                  | John (PM)           |
| 2025-08-05 | 1.1     | Added architectural recommendations and shadcn/ui specs | Winston (Architect) |

## Dev Agent Record

_This section will be populated by the development agent during implementation_

### Agent Model Used

_To be filled_

### Debug Log References

_To be filled_

### Completion Notes List

_To be filled_

### File List

_To be filled_

## QA Results

_This section will be populated by the QA agent after implementation review_
