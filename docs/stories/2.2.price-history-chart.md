# Story 2.2: Price History Chart with Selectable Time Ranges

## Status

Ready

## Story

**As a** user viewing coin details,  
**I want** to see a price history chart with selectable time ranges,  
**so that** I can analyze price trends over different periods.

## Story Context

**Existing System Integration:**

- Integrates with: Coin Detail Page (`/src/app/[coinId]/page.tsx`)
- Technology: Next.js, React, TypeScript, SWR, Tailwind CSS
- Follows pattern: Component structure used in CoinStats, PriceChanges components
- Touch points: Between CoinStats and PriceChanges components on detail page

## Acceptance Criteria

**Functional Requirements:**

1. Display an interactive line chart showing price history for the selected coin
2. Provide time range selector with options: 24h, 7d, 30d, 90d, 1y
3. Chart updates dynamically when user selects different time range

**Integration Requirements:**

4. Existing coin detail page layout and functionality continues to work unchanged
5. New chart component follows existing component patterns (TypeScript interfaces, error handling)
6. Integration with useCoinDetail hook maintains current behavior

**Quality Requirements:**

7. Chart loads with appropriate loading state
8. Errors are handled gracefully with retry option
9. Chart is responsive and works on mobile devices
10. All existing tests continue to pass

## Tasks / Subtasks

**ðŸš¨ CRITICAL: Commit frequently! Each checkbox completion should be a separate commit. See git workflow section at the end for the recommended commit sequence.**

- [x] Install and configure chart library (AC: 1)
  - [x] Install recharts: `npm install recharts`
  - [x] Install required types: `npm install -D @types/recharts`
  - [x] Verify installation and add to build

- [x] Create `usePriceHistory.ts` hook for fetching historical data (AC: 1, 2, 7, 8)
  - [x] Implement SWR hook to fetch from `/coins/{id}/market_chart` endpoint
  - [x] Add query parameters for `vs_currency=usd` and `days={selected}`
  - [x] Handle loading and error states
  - [x] Add proper TypeScript types for price history data
  - [x] Map API response to chart-friendly format

- [x] Create `PriceHistoryChart.tsx` component (AC: 1, 2, 3, 9)
  - [x] Build chart using Recharts Line component
  - [x] Format x-axis with appropriate date/time labels based on range
  - [x] Format y-axis with currency formatting
  - [x] Add responsive container for mobile compatibility
  - [x] Style chart to match existing dark/light theme

- [x] Create `TimeRangeSelector.tsx` component (AC: 2, 3)
  - [x] Use shadcn/ui ToggleGroup for time range options
  - [x] Implement options: 24h, 7d, 30d, 90d, 1y
  - [x] Style active state to match existing UI patterns
  - [x] Handle range selection and emit change events

- [ ] Integrate components into Coin Detail Page (AC: 4, 5, 6)
  - [ ] Add PriceHistoryChart between CoinStats and PriceChanges
  - [ ] Pass coinId prop from page component
  - [ ] Maintain existing component layout and spacing
  - [ ] Ensure chart doesn't break existing responsive design

- [ ] Add loading and error states (AC: 7, 8)
  - [ ] Create skeleton loader matching chart dimensions
  - [ ] Implement error component with retry functionality
  - [ ] Handle edge cases (no data, API limits)
  - [ ] Add appropriate loading animations

- [ ] Create comprehensive unit tests (AC: 10)
  - [ ] Test usePriceHistory hook with mock data
  - [ ] Test PriceHistoryChart rendering with various data sets
  - [ ] Test TimeRangeSelector interactions
  - [ ] Test error and loading states
  - [ ] Test responsive behavior
  - [ ] Ensure all tests pass with `npm run test`

- [ ] Code quality verification
  - [ ] Run `npm run lint` - all linting rules must pass
  - [ ] Run `npm run format:check` - all code must be properly formatted
  - [ ] Run `npm run type-check` - TypeScript compilation must succeed
  - [ ] Pre-commit hooks must be working and passing

- [ ] Follow git workflow standards - COMMIT FREQUENTLY!
  - [ ] **IMPORTANT**: Commit after EACH subtask completion (see `docs/git-workflow.md`)
  - [ ] Use conventional commit format: `(type)[price-history] summary`
  - [ ] Recommended commit sequence:
    - [ ] `(feat)[price-history] Install recharts library and types`
    - [ ] `(feat)[price-history] Create usePriceHistory hook for market chart data`
    - [ ] `(feat)[price-history] Create PriceHistoryChart component with Recharts`
    - [ ] `(feat)[price-history] Create TimeRangeSelector component`
    - [ ] `(feat)[price-history] Integrate chart into coin detail page`
    - [ ] `(feat)[price-history] Add loading skeleton and error states`
    - [ ] `(test)[price-history] Add unit tests for price history components`
    - [ ] `(fix)[price-history] Ensure responsive design on mobile`

## Technical Notes

**Integration Approach:** The chart will be added as a new section in the coin detail page, positioned between the market statistics and price changes components. It will fetch its own data using SWR to avoid modifying the existing useCoinDetail hook.

**Existing Pattern Reference:** Follow the component structure of CoinStats.tsx and PriceChanges.tsx, using Card components from shadcn/ui and maintaining consistent TypeScript interfaces.

**Key Constraints:**

- Must work within CoinGecko API rate limits (30 req/min demo tier)
- Chart library should be lightweight to maintain bundle size
- Must maintain existing page performance

**API Endpoint Details:**

```
GET /coins/{id}/market_chart
Query Parameters:
  - vs_currency: string (default: "usd")
  - days: number (1, 7, 30, 90, 365)
  - interval: string (optional, auto-determined by days)

Response format:
{
  "prices": [[timestamp, price], ...],
  "market_caps": [[timestamp, market_cap], ...],
  "total_volumes": [[timestamp, volume], ...]
}
```

## Architectural Specifications

### Required shadcn/ui Components

1. **Chart Component** (from shadcn/ui)
   - Use: `npx shadcn@latest add chart`
   - Built on Recharts, provides themed chart components
   - Components: `<ChartContainer>`, `<ChartTooltip>`, `<ChartTooltipContent>`

2. **ToggleGroup Component** (already installed)
   - Use for time range selector
   - Components: `<ToggleGroup>`, `<ToggleGroupItem>`

3. **Card Components** (already installed)
   - Use: `Card`, `CardHeader`, `CardTitle`, `CardContent`
   - Follow existing pattern from CoinStats/PriceChanges

4. **Skeleton Component** (already installed)
   - Use for loading states
   - Match chart dimensions for smooth transitions

### Component Architecture

```typescript
// 1. Hook: /src/hooks/usePriceHistory.ts
interface PriceHistoryData {
  timestamp: number;
  price: number;
  formattedDate: string;
  formattedPrice: string;
}

interface UsePriceHistoryReturn {
  data: PriceHistoryData[] | undefined;
  isLoading: boolean;
  error: ApiError | null;
  retry: () => void;
}

// 2. Chart Component: /src/components/PriceHistoryChart.tsx
interface PriceHistoryChartProps {
  coinId: string;
  timeRange: TimeRange;
  onTimeRangeChange: (range: TimeRange) => void;
}

// 3. Time Range Selector: /src/components/TimeRangeSelector.tsx
type TimeRange = '24h' | '7d' | '30d' | '90d' | '1y';

interface TimeRangeSelectorProps {
  value: TimeRange;
  onChange: (value: TimeRange) => void;
}
```

### Implementation Details

1. **Data Fetching Pattern**

   ```typescript
   // Follow existing fetcher pattern
   const endpoint = `${COINGECKO_API_BASE_URL}/coins/${coinId}/market_chart`;
   const params = new URLSearchParams({
     vs_currency: 'usd',
     days: timeRangeToDays[timeRange].toString(),
   });
   ```

2. **Chart Configuration**

   ```typescript
   // Use shadcn/ui Chart with Recharts config
   const chartConfig = {
     price: {
       label: 'Price',
       color: 'hsl(var(--chart-1))',
     },
   } satisfies ChartConfig;
   ```

3. **Time Range Mapping**
   ```typescript
   const timeRangeToDays: Record<TimeRange, number> = {
     '24h': 1,
     '7d': 7,
     '30d': 30,
     '90d': 90,
     '1y': 365,
   };
   ```

### Integration Points

1. **Coin Detail Page Integration**

   ```typescript
   // In /src/app/[coinId]/page.tsx
   // Add between CoinStats and PriceChanges
   <PriceHistoryChart
     coinId={params.coinId}
     timeRange={timeRange}
     onTimeRangeChange={setTimeRange}
   />
   ```

2. **State Management**
   - Use local state for time range selection
   - SWR handles data caching automatically
   - No global state modifications needed

3. **Error Handling**
   - Follow existing pattern with `ApiError` class
   - Display error message in Card with retry button
   - Handle rate limit errors specifically

### Performance Considerations

1. **Data Optimization**
   - Transform API data once in hook
   - Memoize formatted values
   - Use `React.memo` for chart component

2. **Bundle Size**
   - shadcn/ui Chart is tree-shakeable
   - Only imports needed Recharts components
   - Lazy load chart if needed

3. **API Rate Limiting**
   - SWR deduplication prevents duplicate requests
   - Add 1-second debounce on time range changes
   - Cache data for 5 minutes minimum

### Testing Strategy

1. **Unit Tests**

   ```typescript
   // Test data transformation
   // Test error handling
   // Test time range mapping
   // Test chart rendering with mock data
   ```

2. **Integration Tests**
   - Test with actual coin detail page
   - Verify responsive behavior
   - Test loading/error states

3. **E2E Tests**
   - Test time range selection
   - Verify chart updates
   - Test error recovery

## Definition of Done

- [x] Functional requirements met (chart displays with time ranges)
- [x] Integration requirements verified (existing functionality works)
- [x] Existing functionality regression tested
- [x] Code follows existing patterns and standards
- [x] Tests pass (existing and new)
- [x] Documentation updated if applicable

## Risk and Compatibility Check

**Primary Risk:** Additional API calls may hit rate limits when combined with existing detail page call
**Mitigation:** Implement proper caching with SWR and consider debouncing range changes
**Rollback:** Remove chart component imports from detail page - no other changes needed

**Compatibility Verification:**

- [x] No breaking changes to existing APIs
- [x] No database changes
- [x] UI changes follow existing design patterns
- [x] Performance impact is acceptable (lazy load chart if needed)

## Change Log

| Date       | Version | Description            | Author    |
| ---------- | ------- | ---------------------- | --------- |
| 2025-08-05 | 1.0     | Initial story creation | John (PM) |

## Dev Agent Record

_This section will be populated by the development agent during implementation_

### Agent Model Used

Claude Opus 4 (claude-opus-4-20250514)

### Debug Log References

### Completion Notes List

- Installed shadcn/ui chart component which includes recharts dependency
- Chart component created at src/components/ui/chart.tsx
- Created usePriceHistory hook with proper data transformation and error handling
- Created TimeRangeSelector component using existing ToggleGroup
- Created PriceHistoryChart component with loading, error, and empty states

### File List

- src/components/ui/chart.tsx (new)
- src/hooks/usePriceHistory.ts (new)
- src/components/TimeRangeSelector.tsx (new)
- src/components/PriceHistoryChart.tsx (new)
- package.json (modified)
- pnpm-lock.yaml (modified)
